Есть корзина покупок.

Данные о заказанных товарах хранятся в БД (товар, сессия пользователя). Когда пользователь заходит на сайт запускается механизм:

   session_start();
    if(!isset($_COOKIE["sid"]))
    {
    setcookie ("sid", session_id(), time()+3600*48);
    $sid = $_COOKIE["sid"];
    }
    else
    {
    $sid = $_COOKIE["sid"];
    }
Т.е. если куки нет, генерируем sid, пишем в куку и далее используем sid для добавления продукции в БД. Если кука есть, берем из неё sid и используем.

После оформления заказа: setcookie ("sid", '', time()-3600); session_destroy();

Удаляем куку, рушим сессию, очищаем бд от заказанной продукции.

По факту работает не правильно, значение sid которое берется разное, где ошибка может быть?

АП. После очистки кук в браузере. 1 заказ отсылается верно, с заказанными товарами и т.д. Если после этого начать оформлять заказ ещё раз он приходит пустой, а корзина не очищается и откуда то появляется еще одна сессия.

session cookie php
задан 17 Окт '12 10:39
%D0%97%D0%BE%D1%80%D0%BA%D0%B8%D0%B9's gravatar image
Зоркий
2.4k●1●13 
86% принятых
изменен 17 Окт '12 10:49
1 ответ старыеновыеценные
2
 setcookie ("sid", session_id(), time()+3600*48);
    $sid = $_COOKIE["sid"];
Здесь ошибка. Кука может быть получена только после обновления страницы. Так что должно быть:

 $sid = session_id();
 setcookie ("sid", $sid, time()+3600*48);
ссылка
отвечен 17 Окт '12 10:42
%D0%A0%D0%B0%D0%B2%D0%BD%D0%BE%D0%B4%D1%83%D1%88%D0%BD%D1%8B%D0%B9's gravatar image
Равнодушный
3.6k●1●8
Нет, не в этом дело.
(17 Окт '12 10:50)Зоркий
В любом случае, это ошибка. А значит - есть и еще...
А именно:
setcookie ("sid", '', time()-3600); - куку сделали пустой, но это не значит, что она больше не существует. Т.е. isset($_COOKIE["sid"]) === true. Необходимо проверять не только на существование, но и на значение.
(17 Окт '12 10:56)Равнодушный
Ошибки пофиксил. isset заменил на empty. Вроде заработал, сейчас буду тестировать. Может ещё какие косяки есть?
(17 Окт '12 11:06)Зоркий
В приведенном коде больше не вижу.
